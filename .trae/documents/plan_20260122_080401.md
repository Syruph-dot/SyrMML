# MMLSyr编译器设计与实现方案

## 1. 项目概述

构建MMLSyr语言及其Python编译器，作为MML的高级语言扩展，主要改进包括：
- 支持相对路径include
- 弃用R轨道，K轨道直接调用宏

## 2. MMLSyr语法设计

### 2.1 相对路径include

```mmlsyr
# 绝对路径（保持兼容）
#include D:\Ment\Syrmml\header.mml

# 相对路径（新增）
#include "header.mml"
#include "../common/soundbank.mml"
```

### 2.2 K轨道直接调用宏

```mmlsyr
# 宏定义（保持兼容）
!Kick @1c
!Snare @2c
!CloseHat @128c

# K轨道直接调用宏（新增）
K [!Kick 8 !Snare 8 !CloseHat 8]4
K [r8 !Kick 8]2 [!Snare 8 !Kick 8]2

# 嵌套宏调用
!DrumPattern [!Kick 8 !Snare 8]
K [!DrumPattern]4
```

## 3. 编译器架构

### 3.1 核心组件

1. **预处理器**：
   - 处理include指令
   - 解析相对路径，转换为绝对路径
   - 递归包含文件

2. **宏处理器**：
   - 收集宏定义
   - 解析K轨道中的宏调用
   - 生成对应的R轨道定义

3. **代码生成器**：
   - 生成标准MML代码
   - 插入生成的R轨道定义
   - 更新K轨道调用

4. **主控制器**：
   - 协调各组件工作流
   - 处理命令行参数

### 3.2 工作流程

```
输入MMLSyr文件
  ↓
预处理器处理include
  ↓
解析器解析MMLSyr语法
  ↓
宏处理器分析K轨道宏调用
  ↓
生成器生成R轨道定义和K轨道调用
  ↓
输出标准MML文件
```

## 4. 实现细节

### 4.1 相对路径处理

```python
# 当前文件路径
current_path = os.path.dirname(input_file_path)

# 相对路径转换
def resolve_include_path(include_path, current_file_path):
    if include_path.startswith(('"', '')):
        # 相对路径
        include_path = include_path.strip('"\'')
        return os.path.abspath(os.path.join(
            os.path.dirname(current_file_path),
            include_path
        ))
    else:
        # 绝对路径
        return include_path
```

### 4.2 K轨道宏转换

```python
# 宏调用到R轨道的映射
r_counter = 0
r_mapping = {}

# 处理K轨道中的宏调用
def process_k_track(k_content):
    global r_counter
    
    # 查找所有宏调用
    macro_calls = extract_macro_calls(k_content)
    
    generated_r = []
    updated_k = k_content
    
    for macro_call in macro_calls:
        if macro_call not in r_mapping:
            # 生成新的R轨道定义
            r_name = f"R{r_counter}"
            r_mapping[macro_call] = r_name
            generated_r.append(f"{r_name}\t{macro_call}")
            r_counter += 1
        
        # 更新K轨道中的调用
        updated_k = updated_k.replace(macro_call, r_mapping[macro_call])
    
    return generated_r, updated_k
```

## 5. 代码结构

```
mmlsyc/
├── __init__.py
├── compiler.py        # 主编译器类
├── preprocessor.py    # 预处理器
├── parser.py          # 语法解析器
├── generator.py       # 代码生成器
├── utils.py           # 工具函数
└── main.py           # 命令行入口
```

## 6. 命令行接口

```bash
# 基本用法
python -m mmlsyc input.mmlsyr -o output.mml

# 详细选项
python -m mmlsyc --help
```

## 7. 测试方案

### 7.1 单元测试

- 相对路径转换测试
- 宏调用提取测试
- R轨道生成测试
- K轨道更新测试

### 7.2 集成测试

- 完整编译流程测试
- 嵌套include测试
- 复杂宏调用测试
- 实际MML文件编译测试

## 8. 示例转换

### 输入：MMLSyr文件

```mmlsyr
#include "header.mml"

!Kick @1c
!Snare @2c
!CloseHat @128c

K [!Kick 8 !Snare 8 !CloseHat 8]4
```

### 输出：标准MML文件

```mml
#include D:\Ment\Syrmml\header.mml

!Kick @1c
!Snare @2c
!CloseHat @128c

R0	[!Kick 8 !Snare 8 !CloseHat 8]4
K	R0
```

## 9. 扩展计划

- 支持更多高级语法特性
- 添加错误检查和提示
- 实现语法高亮和编辑器支持
- 提供MML到MMLSyr的反向转换

## 10. 技术栈

- Python 3.8+
- 标准库（os, sys, re, argparse）
- 可选：PLY（Python Lex-Yacc）用于更复杂的语法解析

## 11. 开发进度

1. **第一阶段**：核心功能实现
   - 相对路径include处理
   - 基本K轨道宏转换
   - 命令行接口

2. **第二阶段**：功能增强
   - 复杂宏调用支持
   - 嵌套include支持
   - 错误处理和提示

3. **第三阶段**：测试和文档
   - 完整测试套件
   - 使用文档
   - 示例项目

## 12. 预期成果

- 完整的MMLSyr编译器实现
- 详细的使用文档
- 示例项目和测试用例
- 可扩展的代码架构，支持未来功能扩展

通过该编译器，用户可以使用更简洁、更灵活的MMLSyr语言编写音乐，同时保持与标准MML的兼容性，提高音乐创作的效率和可读性。